{% extends 'oragePage.html.twig' %}
{% block title %}Cours disponibles{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/palette.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/lesson.css') }}">
    <script defer src="{{ asset('JS/cours.js') }}"></script>
    <style>
        {% for niveaux, categorie in arborescence %}
            {% for category, cours_list in categorie %}
                 /**/
                .tree-item-{{ category }}::before{
                    background: {{ cours_list[0].categorie.color }};
                }
            {% endfor %}
        {% endfor %}
    </style>
{% endblock %}

{% block body %}
    {% include "component/navbar.html.twig" %}

    <div class="navbody">
        {% include "component/flashRenderer.html.twig" %}
    </div>

    <div class="container-wrapper">
        <!-- Banni√®re du catalogue -->
        {% set banner_title = "Catalogue des <span class='hero-highlight'>Cours</span>" %}
        {% set banner_description = '<p class="hero-subtitle">D√©couvrez notre collection de cours organis√©s par cat√©gorie et niveau</p>' %}
        {% include "component/banner.html.twig" %}

        <div class="main-content">
            <div class="layout-grid">
                <!-- Menu d'arborescence -->
                <aside class="tree-container">
                    <h3 class="tree-title">
                        <span class="tree-icon">üìö</span>
                        Parcourir les cours
                    </h3>
                    <div class="tree-content">
                        {% for niveaux, categorie in arborescence %}
                            <div class="tree-node">
                                <!-- Cat√©gorie avec toggle -->
                                <div class="tree-toggle" data-niveau="{{ niveaux }}">
                                    <span class="tree-toggle-text">{{ niveaux }}</span>
                                    <span class="tree-toggle-arrow">‚ñ∏</span>
                                </div>
                                <div class="tree-children">
                                    {% for category, cours_list in categorie %}
                                        <!-- Niveau de cours -->
                                        <div class="tree-item tree-niveau"
                                             data-categorie="{{ category }}"
                                             data-niveau="{{ niveaux }}">

                                            <span class="tree-item-text tree-item-{{ category }}">{{ category }}</span>

                                            <span class="tree-item-count">({{ cours_list|length }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </aside>

                <!-- Section principale des cours -->
                <section class="courses-section">
                    <div class="section-header">
                        <h2 class="section-title">Cours disponibles</h2>
                        <div class="results-info">
                            <span class="results-count" id="resultsCount">
                                <strong>{{ totalCours ?? 0 }}</strong> cours trouv√©s
                            </span>
                        </div>
                    </div>

                    <!-- Barre de filtre actif -->
                    <div class="filter-bar" id="filterBar" style="display: none;">
                        <div class="filter-content">
                            <span class="filter-label">Filtre actif :</span>
                            <span class="filter-text" id="filterText"></span>
                            <button class="btn-clear-filter" id="clearFilterBtn">
                                <span>‚úï</span> Effacer le filtre
                            </button>
                        </div>
                    </div>

                    <!-- Message vide -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="empty-icon">üîç</div>
                        <p class="empty-message">Aucun cours trouv√© avec les crit√®res s√©lectionn√©s</p>
                        <button class="hero-button" id="showAllCoursesBtn">Voir tous les cours</button>
                    </div>

                    <!-- Grille des cours -->
                    <div class="courses-grid" id="coursesGrid">
                        {% for niveau, categories in arborescence %}
                            {% for categorie, cours_list in categories %}
                                {% for cours in cours_list %}
                                    <article class="course-card"
                                             data-course-id="{{ cours.id }}"
                                             data-category="{{ categorie }}"
                                             data-niveau="{{ niveau }}">
                                        <div class="course-card-header">
                                            <h3 class="course-card-title">{{ cours.nomCours }}</h3>
                                            <p class="course-card-subtitle">{{ cours.getNiveau().getNomNiveau() }}</p>
                                        </div>
                                        <div class="course-card-body">
                                            <div class="course-badges">
                                                <span class="course-badge badge-categorie" style="background: {{ cours.categorie.color }}">
                                                    {{ cours.getCategorie().getLibele() }}
                                                </span>
                                                <span class="course-badge badge-niveau">
                                                    {{ cours.getNiveau().getNomNiveau() }}
                                                </span>
                                            </div>

                                            <p class="course-description">
                                                Ce cours vous initie aux concepts fondamentaux de {{ cours.nomCours }}.
                                                Explorez les notions essentielles et d√©veloppez vos comp√©tences.
                                            </p>

                                            <div class="course-actions">
                                                {% if cours.chapitres is defined and cours.chapitres|length > 0 %}
                                                    {% set firstChapitre = cours.chapitres|first %}
                                                    {% if firstChapitre.depots is defined and firstChapitre.depots|length > 0 %}
                                                        {% set firstDepot = firstChapitre.depots|first %}
                                                        <a href="{{ path('app_depot_show_latest', {'identifier': firstDepot.identifier}) }}"
                                                           class="btn-course btn-primary">
                                                            <span class="btn-icon">üìñ</span>
                                                            Consulter
                                                        </a>
                                                    {% else %}
                                                        <button class="btn-course btn-disabled" disabled>
                                                            <span class="btn-icon">‚è≥</span>
                                                            Bient√¥t disponible
                                                        </button>
                                                    {% endif %}
                                                {% else %}
                                                    <button class="btn-course btn-disabled" disabled>
                                                        <span class="btn-icon">‚è≥</span>
                                                        Bient√¥t disponible
                                                    </button>
                                                {% endif %}

                                                <!-- Bouton de t√©l√©chargement -->
                                                <button class="btn-course btn-secondary download-btn"
                                                        data-course-id="{{ cours.id }}"
                                                        data-course-name="{{ cours.nomCours|e('js') }}">
                                                    <span class="btn-icon">üì•</span>
                                                    T√©l√©charger
                                                </button>
                                            </div>
                                        </div>
                                    </article>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </section>
            </div>
        </div>
    </div>

    {% include "component/footer.html.twig" %}
{% endblock %}
